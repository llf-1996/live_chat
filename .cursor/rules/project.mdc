# 在线客服系统 - 项目规则

## 项目概述

基于 FastAPI + MySQL + Vue3 + WebSocket 的实时在线客服系统，支持多角色（买家、商户、官方客服、管理员）在线沟通。

## 技术栈

**后端：** Python 3.11+ | FastAPI | MySQL + SQLAlchemy | Alembic | WebSocket | Uvicorn  
**前端：** Vue 3 | Vue Router | Vite | Element Plus | Pinia | Axios

## 核心架构原则

### 1. 会话驱动架构
- 所有聊天功能基于 Conversation 模型
- 用户列表从会话派生，不直接查询所有用户

### 2. 双通道设计
- **HTTP**: 持久化存储（POST /api/messages/）
- **WebSocket**: 实时推送消息

### 3. 角色权限
- **买家 (b{数字})**: 访问 /chat，与商户对话
- **商户 (m{数字})**: 访问 /chat，与客户对话
- **官方客服 (p{数字})**: 访问 /chat，类似商户
- **管理员 (a{数字})**: 访问 /admin，只读监控

### 4. 路由分离
- `/chat` - 聊天页面（买家、商户、客服）
- `/admin` - 管理后台（仅管理员）
- 参数：`user_id`（必需）、`target`（可选）

## 代码规范

### 后端规范

#### API 接口
```python
# 列表接口返回 RESTful 格式
from app.schemas import PaginatedResponse

@router.get("/", response_model=PaginatedResponse[ModelResponse])
async def get_list(page: int = 1, page_size: int = 20):
    return PaginatedResponse(count=total, results=items)

# 单个资源直接返回对象
@router.get("/{id}", response_model=ModelResponse)
async def get_item(id: str):
    return item
```

#### 分页参数
- 使用 `page`（页码，从1开始）和 `page_size`（每页记录数）
- 计算 skip：`skip = (page - 1) * page_size`
- 默认值：用户/会话 20，消息 50

#### 用户ID规则
- 类型：`String(50)`（不使用整数）
- 格式：`{角色首字母}{数字}`
  - 买家：b1, b2
  - 商户：m1, m2
  - 管理员：a1, a2
  - 客服：p1, p2

#### 数据库模型
- 时间字段：Unix 时间戳（整数）
- 用户ID字段：`String(50)`
- 外键：`Column(String(50), ForeignKey("users.id"))`

#### WebSocket 管理
- 用户级连接：`active_connections: Dict[str, WebSocket]`
- 管理员监控池：`admin_users: Set[str]`
- 推送给会话参与者 + 所有在线管理员

#### 环境变量配置

⚠️ **所有配置必需，无默认值！使用 `is None` 判断（不用 `if not`）**

```python
# ✅ 正确
value = os.getenv("DATABASE_URL")
if value is None:
    raise ValueError("DATABASE_URL 环境变量未设置")

# ❌ 错误：会把 False, 0, "" 误判
if not value:
    raise ValueError("未设置")
```

**必需配置（16项）：**
- DATABASE_URL, DEBUG_SQL
- JWT_SECRET_KEY, JWT_ALGORITHM, JWT_ACCESS_TOKEN_EXPIRE_DAYS
- HOST, PORT, RELOAD, DEBUG, BASE_URL
- CORS_ORIGINS, MEDIA_DIR, MAX_FILE_SIZE
- APP_TITLE, APP_DESCRIPTION, APP_VERSION

### 前端规范

#### API 调用
```javascript
// baseURL 配置为 /api
api.get('/users/')              // → /api/users/
api.post('/messages/', data)    // → /api/messages/
```

#### 列表数据处理
```javascript
const response = await api.get('/users/')
users.value = response.results  // 从 results 获取数据
totalUsers.value = response.count
```

#### 路由守卫
- 检查 `user_id` 参数
- 验证用户有效性
- 管理员页面验证 `role === 'admin'`

#### 组件规范
- Composition API
- Pinia 状态管理
- Element Plus 按需引入
- Scoped CSS

#### 响应式设计
- 断点：手机 <768px，平板 768-1023px，桌面 ≥1024px
- 手机端：单栏布局 + 底部导航（`activePanel` 控制）
- 平板/桌面：多栏布局
- 移动端优化：隐藏快捷键提示、半屏弹窗、自动切换视图

## 文档规范

### 文档层级

1. **README.md** - 项目概览、快速开始、使用教程
2. **backend/README.md** - 后端技术文档（技术栈、配置、API、数据库、部署）
3. **frontend/README.md** - 前端技术文档（技术栈、配置、组件、状态管理、部署）

### 规则

❌ 不要创建独立的 .md 文档（如 ENV_README.md）  
✅ 将内容整合到对应的主 README.md 中  
✅ 特殊说明作为章节添加，不单独建文件

**优势：** 文档集中、易于维护、查找方便、避免重复

## 关键注意事项

1. ⚠️ **环境变量验证**
   - 必须用 `is None` 判断（不用 `if not value`）
   - `"False"`, `"0"`, `""` 都是有效配置值
   - 所有16个配置项都必需，无默认值

2. ⚠️ **用户ID类型**
   - 使用字符串 `String(50)`，不用整数
   - 格式：角色首字母 + 数字（b1, m1, a1, p1）

3. ⚠️ **列表接口格式**
   - 必须返回 `{ count, results }` 格式
   - 不能直接返回数组

4. ⚠️ **文件上传**
   - 保留原文件名：`原文件名_{时间戳}.扩展名`
   - 按日期存储：`media/uploads/{年}/{月}/{日}/`
   - 返回完整 URL（通过 BASE_URL 拼接）

5. ⚠️ **Event Loop 清理**
   - 应用关闭时调用 `await engine.dispose()`
   - 避免 "Event loop is closed" 错误

6. ⚠️ **响应式设计**
   - 所有组件必须支持移动端（<768px）
   - 使用 CSS 媒体查询适配
   - 移动端触控友好（按钮 ≥44×44px）

## 启动流程

```bash
# 后端
cd backend
cp .env.example .env     # 编辑配置
python main.py

# 前端
cd frontend
cp .env.example .env     # 编辑配置
pnpm install
pnpm dev

# 创建管理员
cd backend
python create_admin.py
```

## 内置测试用户

- 管理员：a1, a2
- 买家：b1（保安堂药房）, b2（异世界药局）
- 商户：m1（保和堂医药集团）, m2（阿纳斯蒂制药）, m3（梅迪西斯制药）
- 客服：p1（官方客服）

## API 文档

- Swagger UI: http://localhost:11075/docs
- ReDoc: http://localhost:11075/redoc
