# 在线客服系统 - 开发规则

基于 FastAPI + MySQL + Vue3 + WebSocket 的实时在线客服系统。

## 技术栈

**后端：** Python 3.11+ | FastAPI | MySQL + SQLAlchemy | Alembic | WebSocket | Uvicorn  
**前端：** Vue 3 | Vite | Element Plus | Pinia | Vue Router | Axios

## 核心架构

### 1. 会话驱动
- 所有聊天基于 Conversation 模型
- 用户列表从会话派生，不直接查询所有用户

### 2. 双通道通信
- **HTTP**: 持久化存储（POST /api/messages/）
- **WebSocket**: 实时推送（ws://*/api/ws/{user_id}）

### 3. 角色权限
- **买家 (b1, b2)**: /chat 与商户对话
- **商户 (m1, m2, m3)**: /chat 与客户对话
- **客服 (p1)**: /chat 类似商户
- **管理员 (a1, a2)**: /admin 只读监控

## 代码规范

### 后端

#### 环境变量验证

```python
# ✅ 正确：使用 is None（"False", "0", "" 都是有效值）
value = os.getenv("DATABASE_URL")
if value is None:
    raise ValueError("DATABASE_URL 环境变量未设置")

# ❌ 错误：会把 False, 0, "" 误判
if not value:
    raise ValueError("未设置")
```

**必需配置（16项）：**
DATABASE_URL, DEBUG_SQL, JWT_SECRET_KEY, JWT_ALGORITHM, JWT_ACCESS_TOKEN_EXPIRE_DAYS, HOST, PORT, RELOAD, DEBUG, BASE_URL, CORS_ORIGINS, MEDIA_DIR, MAX_FILE_SIZE, APP_TITLE, APP_DESCRIPTION, APP_VERSION

#### API 接口规范

```python
# 列表接口：返回 { count, results }
@router.get("/", response_model=PaginatedResponse[ModelResponse])
async def get_list(page: int = 1, page_size: int = 20):
    skip = (page - 1) * page_size
    return PaginatedResponse(count=total, results=items)

# 单个资源：直接返回对象
@router.get("/{id}", response_model=ModelResponse)
async def get_item(id: str):
    return item
```

#### 用户 ID 规则
- 类型：`String(50)`（不用整数）
- 格式：`{角色首字母}{数字}` (b1, m1, a1, p1)

#### WebSocket 管理
```python
active_connections: Dict[str, WebSocket]  # 用户连接
admin_users: Set[str]                     # 管理员监控池
# 推送给会话参与者 + 所有在线管理员
```

### 前端

#### 环境变量配置

```env
# ⚠️ 只配置服务器地址，不含路径
VITE_API_BASE_URL=http://localhost:11075    # 不含 /api
VITE_WS_BASE_URL=ws://localhost:11075       # 不含 /api/ws
```

**原因：** 代码中已配置路径
- HTTP: `baseURL: '/api'` + `/auth/login` = `/api/auth/login`
- WebSocket: `${wsBaseUrl}/api/ws/${userId}`

#### API 调用

```javascript
// baseURL 已配置为 /api
api.get('/users/')              // → /api/users/
api.post('/messages/', data)    // → /api/messages/

// 列表数据处理
const response = await api.get('/users/')
users.value = response.results  // 从 results 获取
totalUsers.value = response.count
```

#### 响应式设计
- 断点：手机 <768px，平板 768-1023px，桌面 ≥1024px
- 移动端：单栏布局 + `activePanel` 切换
- 桌面端：多栏并列

## 关键注意事项

### 1. 环境变量验证
- ⚠️ 必须用 `is None` 判断（不用 `if not value`）
- `"False"`, `"0"`, `""` 都是有效配置值
- 所有配置都必需，无默认值

### 2. 用户 ID 类型
- ⚠️ 使用字符串 `String(50)`，不用整数
- 格式：角色首字母 + 数字（b1, m1, a1, p1）

### 3. 列表接口格式
- ⚠️ 必须返回 `{ count, results }` 格式
- 不能直接返回数组

### 4. Event Loop 清理
- ⚠️ 应用关闭时调用 `await engine.dispose()`
- 避免 "Event loop is closed" 错误

### 5. 静态文件处理
- **开发环境**: FastAPI 提供 (`app.mount("/api/media", ...)`)
- **生产环境**: Nginx 直接提供（性能提升 10-100 倍）
- Nginx 配置顺序: `/api/media/` 必须在 `/api/` 之前

### 6. Nginx 代理配置
- ⚠️ 必须配置 `X-Forwarded-For` 和 `X-Forwarded-Proto`（传递客户端信息）
- ⚠️ 关闭缓冲 `proxy_buffering off` 和 `proxy_request_buffering off`（避免参数丢失）
- ⚠️ `proxy_pass` 末尾不加 `/`（保留完整路径）

## API 访问地址

**所有接口在 `/api` 路径下：**

- API 文档: http://localhost:11075/api/docs
- 健康检查: http://localhost:11075/api/health
- WebSocket: ws://localhost:11075/api/ws/{user_id}
- 静态文件: http://localhost:11075/api/media/*

## 快速启动

```bash
# 后端
cd backend
cp .env.example .env        # 配置16项环境变量
pip install -r requirements.txt
alembic upgrade head
python create_admin.py      # 创建管理员
python main.py

# 前端
cd frontend
cp .env.example .env        # 配置环境变量
pnpm install
pnpm dev
```

## 内置测试用户

- 管理员：a1, a2（密码：admin123）
- 买家：b1（保安堂药房）, b2（异世界药局）
- 商户：m1（保和堂医药）, m2（阿纳斯蒂制药）, m3（梅迪西斯制药）
- 客服：p1（官方客服）

## 访问示例

```
# 登录
http://localhost:5173/login

# 买家与商户对话
http://localhost:5173/chat?user_id=b1&target_user_id=m1

# 商户查看客户列表
http://localhost:5173/chat?user_id=m1

# 管理员后台
http://localhost:5173/admin?user_id=a1
```
