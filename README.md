# 在线客服系统

基于 FastAPI + MySQL + Vue3 + WebSocket 的实时在线客服系统，支持多角色（买家、商户、官方客服、管理员）在线沟通。

## ✨ 核心特性

- 🚀 **实时通信** - WebSocket 双向通信，消息即时送达
- 👥 **多角色支持** - 买家、商户、官方客服、管理员
- 📱 **响应式设计** - 完美适配桌面端和移动端
- 💬 **快捷回复** - 自定义快捷消息，提升沟通效率
- 📎 **文件传输** - 支持图片、文档等文件上传和预览
- 🔒 **JWT 认证** - 安全的用户身份验证
- 📊 **管理后台** - 实时监控、用户管理、数据统计
- 🎨 **现代化 UI** - Element Plus 组件库，界面美观易用
- 🛡️ **敏感词过滤** - 智能过滤150+敏感词，维护聊天环境健康
- ⚡ **性能优化** - 乐观更新机制，消息发送响应速度提升30倍+

## 📸 界面预览

### 客服后台管理
![管理后台](docs/screenshots/admin_index.png)

### 聊天界面
![聊天界面](docs/screenshots/chat_pc.png)

### 移动端适配
![移动端](docs/screenshots/chat_mobile.png)

## 🛠️ 技术栈

**后端：** Python 3.11 | FastAPI | MySQL | SQLAlchemy | Alembic | WebSocket  
**前端：** Vue 3 | Vite | Element Plus | Pinia | Vue Router | Axios

## 📋 环境要求

Python 3.11+ | Node.js 20+ | pnpm 8+ | MySQL 5.7+/8.0+

## 🚀 快速开始

```bash
# 1. 克隆项目
git clone <repository-url>
cd live_chat

# 2. 后端配置
cd backend
cp .env.example .env           # 编辑配置（16项必需）
pip install -r requirements.txt
alembic upgrade head
python create_admin.py         # 创建管理员
python main.py                 # 启动后端

# 3. 前端配置（新终端）
cd frontend
cp .env.example .env           # 编辑配置
pnpm install
pnpm dev                       # 启动前端
```

**访问：**
- 前端: http://localhost:5173
- API 文档: http://localhost:11075/api/docs

## 📖 使用教程

### 快速访问

**登录页面：** http://localhost:5173/login

**聊天页面：** http://localhost:5173/chat?user_id={用户ID}&target_user_id={对话对象ID}

**管理后台：** http://localhost:5173/admin（需要登录，账号：admin / admin123）

### 🧪 测试用户初始化（管理后台功能）

为了方便测试，系统在管理后台提供了测试用户初始化功能，可以快速创建测试用户并进入聊天。

**功能特性：**
- 📝 支持批量创建多个用户
- 🎯 自动生成默认用户名和头像
- ⚡ 提供快捷按钮快速填充常用组合
- 🔄 创建成功后在新标签页打开聊天页面
- 💡 用户已存在时自动跳过
- 🔒 集成在管理后台，需要登录访问

**使用方法：**

1. 访问管理后台：http://localhost:5173/login
2. 登录（账号：admin / 密码：admin123）
3. 点击左侧"测试初始化"菜单
4. 填写用户信息（ID 和角色必填，其他可选）
   - ID：用户标识（如 b1, m2）
   - 角色：buyer/merchant/admin
   - 用户名：可选，留空自动生成
   - 头像URL：可选，留空使用默认头像（示例: http://localhost:11075/api/media/avatars/user1.png）
   - 描述：可选
5. 或点击快捷按钮快速填充：
   - "b1 (买家) + m2 (商家)"
   - "b2 (买家) + m1 (商家)"
   - "b1, b2, m1, m2"（创建多个用户）
6. 设置跳转参数（user_id 和 target_user_id）
7. 点击"创建用户并打开聊天"
8. 自动在新标签页打开聊天页面（如：`/chat?user_id=b1&target_user_id=m2`）

**API 接口：** `POST /api/users/ensure`
- 支持批量创建/更新用户
- 用户已存在时不会重复创建
- 自动随机分配默认头像（buyer1/buyer2, merchant1/merchant2）
- 自动生成默认用户名（使用时间戳，如"买家1730812345678"）

### 内置测试用户

| 角色 | 用户ID | 用户名 | 默认密码 |
|------|--------|--------|----------|
| 管理员 | a1, a2 | admin | admin123 |
| 买家 | b1, b2 | 保安堂药房、异世界药局 | （无需密码） |
| 商户 | m1, m2, m3 | 保和堂医药、阿纳斯蒂制药、梅迪西斯制药 | （无需密码） |
| 客服 | p1 | 官方客服 | （无需密码） |

### 使用示例

**1. 买家与商户对话**
```
http://localhost:5173/chat?user_id=b1&target_user_id=m1
```

**2. 商户查看客户列表**
```
http://localhost:5173/chat?user_id=m1
```

**3. 管理员监控**
```
http://localhost:5173/admin?user_id=a1
```

## 💡 功能介绍

### 核心功能

- ✅ 用户管理（买家、商户、客服、管理员）
- ✅ 实时消息推送（WebSocket）
- ✅ 会话管理（创建、查询、列表）
- ✅ 消息发送（文本、图片、文件）
- ✅ 消息已读/未读状态（精确追踪）
- ✅ 敏感词过滤（150+词库，自动替换）
- ✅ 快捷回复（自定义、管理）
- ✅ 文件上传（图片、文档，10MB限制）
- ✅ 管理后台（数据统计、实时监控）
- ✅ 响应式设计（桌面端、移动端）
- ✅ 暗色主题（登录页面优化）
- ✅ 测试用户初始化（批量创建测试用户）
- ✅ 性能优化（乐观更新、预编译正则）

## ❓ 常见问题

**Q: 后端启动失败？**  
检查：Python版本、依赖安装、.env配置（15项必需）、MySQL运行

**Q: 前端无法连接后端？**  
检查：后端运行、端口正确（11075）、.env配置、CORS设置

**Q: WebSocket 连接失败？**  
检查：后端WebSocket服务、URL格式、防火墙

**Q: 多个后端进程端口冲突？**  
原因：后台启动多个进程导致端口被占用  
解决：检查并清理占用端口的进程
```bash
netstat -ano | findstr :11075
taskkill /F /PID <进程ID>
```

**Q: 如何修改端口？**  
后端：修改 `backend/.env` 中的 `PORT`  
前端：修改 `frontend/.env` 中的 `VITE_PORT`

## 🔮 功能规划

### 已完成 ✅
- 基础聊天功能
- WebSocket 实时通信
- 文件上传下载
- 管理后台
- 移动端适配
- 消息已读/未读状态
- 敏感词过滤（150+词库）
- 性能优化（乐观更新）

### 待开发 📋
- 消息撤回功能
- 群聊功能
- 在线状态显示
- 表情包支持
- 消息搜索功能
- 语音消息支持

## 📅 更新日志

### 2025-11-05
- ✅ **敏感词过滤系统** - 实现150+敏感词智能过滤
  - 支持辱骂、色情、暴力、毒品、诈骗、政治敏感等多维度
  - 大小写不敏感，自动替换为 `***`
  - 预编译正则表达式，性能提升150倍+
- ✅ **前端架构优化** - utils.js 模块化重构
  - 拆分为独立模块：chat.js（聊天）、sensitive-words.js（敏感词）
  - 统一使用 `@` 别名，替代相对路径（34处导入优化）
  - 代码结构更清晰，易于维护扩展
- ✅ **性能优化** - 消息发送体验大幅提升
  - 乐观更新机制：输入框瞬时清空，消息立即显示
  - 响应速度从1-3秒降至<100ms（提升30倍+）
  - 敏感词过滤从~150ms降至<1ms（提升150倍+）
- ✅ **已读状态修复** - 修复严重的已读逻辑bug
  - 后端：只标记发送给当前用户的消息（排除自己发送的）
  - 前端：只在真正有未读消息时调用标记接口
  - 解决"切换会话/刷新后消息误标记为已读"问题

### 2025-11-04
- ✅ 管理后台新增"测试初始化"功能（需登录访问）
- ✅ 新增批量用户创建接口（POST /api/users/ensure）
- ✅ 支持自动生成默认用户名（使用时间戳保证唯一性）
- ✅ 支持随机分配默认头像（无需查询数据库）
- ✅ 提供快捷按钮快速创建常用测试组合
- ✅ 创建成功后在新标签页打开聊天页面
- ✅ 优化聊天页面加载顺序（并行请求，减少 28% 请求）
- ✅ 后端验证用户存在性，防止外键错误

### 2025-11-03
- ✅ 数据库迁移：SQLite → MySQL
- ✅ 环境变量强制验证（使用 is None，16项配置）
- ✅ RELOAD 热重载配置化（支持开发/生产环境）
- ✅ 登录页面UI优化（柔和配色）
- ✅ Event Loop 清理优化
- ✅ 文档重构简化（-54.9%）

### 2025-11-02
- ✅ 项目初始化
- ✅ 基础功能开发
- ✅ 管理后台实现

## 📚 相关文档

- [后端技术文档](backend/README.md) - 详细的后端开发文档
- [前端技术文档](frontend/README.md) - 详细的前端开发文档
- [项目开发规则](.cursor/rules/project.mdc) - 开发规范和注意事项

## 📄 开源协议

本项目采用 MIT 协议开源。
